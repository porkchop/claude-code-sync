#!/bin/bash
# Claude Code Conversation Sync - Pull from Bitbucket
# Syncs conversations from this repo to ~/.claude

set -e

# Save original directory to return to it at the end
ORIGINAL_DIR="$(pwd)"

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Load configuration
source "$SCRIPT_DIR/lib-claude-sync.sh"
load_config "$SCRIPT_DIR"

CLAUDE_DIR="$CLAUDE_DATA_DIR"
REPO_DIR="$SCRIPT_DIR/conversations"

echo "=== Claude Code Conversation Sync - Pull ==="
echo "Syncing from: $REPO_DIR"
echo "Syncing to: $CLAUDE_DIR"
echo ""

log_verbose "Using branch: $CLAUDE_SYNC_BRANCH"

# Check if conversations directory and repo exist
if [ ! -d "$REPO_DIR" ]; then
    echo "No conversations directory found."
    echo "Run claude-sync-push first to initialize."
    cd "$ORIGINAL_DIR"
    exit 0
fi

# Pull from git if conversations repo exists
if [ -d "$REPO_DIR/.git" ]; then
    cd "$REPO_DIR"
    if git remote | grep -q origin 2>/dev/null; then
        echo "Pulling from remote..."
        git pull origin "$CLAUDE_SYNC_BRANCH" 2>/dev/null || {
            echo "Warning: Could not pull. Using local copy."
        }
    else
        echo "No git remote configured in conversations/. Using local copy."
    fi
    cd "$SCRIPT_DIR"
else
    echo "No git repository in conversations/. Using local copy."
    echo "Run claude-sync-push to initialize the repository."
fi

# Create Claude directory if it doesn't exist
mkdir -p "$CLAUDE_DIR"

# Sync with rsync (preserves newer files)
echo ""
echo "Syncing conversations to $CLAUDE_DIR..."

# Sync projects
if [ -d "$REPO_DIR/projects" ]; then
    echo "Syncing project conversations..."
    rsync -av --update "$REPO_DIR/projects/" "$CLAUDE_DIR/projects/"
fi

# Sync file-history
if [ -d "$REPO_DIR/file-history" ]; then
    echo "Syncing file history..."
    rsync -av --update "$REPO_DIR/file-history/" "$CLAUDE_DIR/file-history/"
fi

# Sync todos
if [ -d "$REPO_DIR/todos" ]; then
    echo "Syncing todos..."
    rsync -av --update "$REPO_DIR/todos/" "$CLAUDE_DIR/todos/"
fi

# Sync global history (merge, don't overwrite)
if [ -f "$REPO_DIR/history.jsonl" ]; then
    echo "Syncing global history..."
    if [ -f "$CLAUDE_DIR/history.jsonl" ]; then
        # Merge history files (keep both, sort by timestamp)
        cat "$CLAUDE_DIR/history.jsonl" "$REPO_DIR/history.jsonl" | \
            sort -u > "$CLAUDE_DIR/history.jsonl.tmp"
        mv "$CLAUDE_DIR/history.jsonl.tmp" "$CLAUDE_DIR/history.jsonl"
    else
        cp "$REPO_DIR/history.jsonl" "$CLAUDE_DIR/history.jsonl"
    fi
fi

# Set correct permissions
chmod -R u+rwX,go-rwx "$CLAUDE_DIR/projects" 2>/dev/null || true
chmod -R u+rwX,go-rwx "$CLAUDE_DIR/file-history" 2>/dev/null || true
chmod -R u+rwX,go-rwx "$CLAUDE_DIR/todos" 2>/dev/null || true

echo ""
echo "Sync complete!"
echo ""
echo "Note: Restart Claude Code to see the synced conversations."

# Return to original directory
cd "$ORIGINAL_DIR"
