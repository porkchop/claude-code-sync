#!/bin/bash
# Claude Code Conversation Sync - Pull
# Syncs conversations from remote repo to ~/.claude

set -e

# Save original directory to return to it at the end
ORIGINAL_DIR="$(pwd)"

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Load configuration
source "$SCRIPT_DIR/lib-claude-sync.sh"

# Handle --version flag
if [ "$1" = "--version" ] || [ "$1" = "-v" ]; then
    show_version "$SCRIPT_DIR" "claude-sync-pull"
    exit 0
fi

load_config "$SCRIPT_DIR"

CLAUDE_DIR="$CLAUDE_DATA_DIR"
REPO_DIR="$SCRIPT_DIR/conversations"

echo "=== Claude Code Conversation Sync - Pull ==="
echo "Syncing from: $REPO_DIR"
echo "Syncing to: $CLAUDE_DIR"
echo ""

log_verbose "Using branch: $CLAUDE_SYNC_BRANCH"

# Check if repo is initialized
if [ ! -d "$REPO_DIR/.git" ]; then
    echo "Error: Conversations repository not initialized."
    echo ""
    echo "Run 'claude-sync-init' first to set up the repository."
    cd "$ORIGINAL_DIR"
    exit 1
fi

cd "$REPO_DIR"

# Check if encrypted repo is locked
if [ -d ".git/git-crypt" ]; then
    if git-crypt status 2>/dev/null | grep -q "not decrypted"; then
        echo "Error: Repository is encrypted but locked."
        echo ""
        echo "Unlock first with: claude-restore-encryption-key"
        echo "Or manually: cd $REPO_DIR && git-crypt unlock ~/.claude-git-crypt.key"
        cd "$ORIGINAL_DIR"
        exit 1
    fi
fi

# Pull from remote
if git remote | grep -q origin 2>/dev/null; then
    echo "Pulling from remote..."
    git pull origin "$CLAUDE_SYNC_BRANCH" 2>/dev/null || {
        echo "Warning: Could not pull. Using local copy."
    }
else
    echo "No git remote configured. Using local copy."
fi

cd "$SCRIPT_DIR"

# Create Claude directory if it doesn't exist
mkdir -p "$CLAUDE_DIR"

# Smart merge conversations
echo ""
echo "Syncing conversations to $CLAUDE_DIR..."

# Smart merge for JSONL files (conversations) - combines entries from both versions
if [ -d "$REPO_DIR/projects" ]; then
    echo "Merging project conversations (smart JSONL merge)..."
    sync_jsonl_dir "$REPO_DIR/projects" "$CLAUDE_DIR/projects"

    # Also copy any non-JSONL files with rsync
    rsync -av --update --include='*/' --include='*.json' --exclude='*.jsonl' "$REPO_DIR/projects/" "$CLAUDE_DIR/projects/" 2>/dev/null || true
fi

# Sync file-history - use rsync (not JSONL)
if [ -d "$REPO_DIR/file-history" ]; then
    echo "Syncing file history..."
    rsync -av --update "$REPO_DIR/file-history/" "$CLAUDE_DIR/file-history/"
fi

# Sync todos - use rsync (not JSONL)
if [ -d "$REPO_DIR/todos" ]; then
    echo "Syncing todos..."
    rsync -av --update "$REPO_DIR/todos/" "$CLAUDE_DIR/todos/"
fi

# Smart merge global history (JSONL file)
if [ -f "$REPO_DIR/history.jsonl" ]; then
    echo "Merging global history..."
    merge_jsonl "$CLAUDE_DIR/history.jsonl" "$REPO_DIR/history.jsonl" "$CLAUDE_DIR/history.jsonl"
fi

# Consolidate sessions (merge files with same sessionId)
echo "Consolidating sessions..."
consolidate_sessions "$CLAUDE_DIR/projects"

# Set correct permissions
chmod -R u+rwX,go-rwx "$CLAUDE_DIR/projects" 2>/dev/null || true
chmod -R u+rwX,go-rwx "$CLAUDE_DIR/file-history" 2>/dev/null || true
chmod -R u+rwX,go-rwx "$CLAUDE_DIR/todos" 2>/dev/null || true

echo ""
echo "Sync complete!"
echo ""
echo "Note: Restart Claude Code to see the synced conversations."

# Return to original directory
cd "$ORIGINAL_DIR"
