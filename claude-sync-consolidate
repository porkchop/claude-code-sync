#!/bin/bash
# Claude Code Conversation Sync - Consolidate Sessions
# Merges conversation files that share the same sessionId into a single canonical file

set -e

ORIGINAL_DIR="$(pwd)"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Load configuration
source "$SCRIPT_DIR/lib-claude-sync.sh"

# Handle --version flag
if [ "$1" = "--version" ] || [ "$1" = "-v" ]; then
    show_version "$SCRIPT_DIR" "claude-sync-consolidate"
    exit 0
fi

load_config "$SCRIPT_DIR"

CLAUDE_DIR="$CLAUDE_DATA_DIR"

echo "=== Claude Code Conversation Sync - Consolidate Sessions ==="
echo ""
echo "This will merge conversation files that share the same sessionId."
echo "Target: $CLAUDE_DIR/projects"
echo ""

# Check if projects directory exists
if [ ! -d "$CLAUDE_DIR/projects" ]; then
    echo "No projects directory found at $CLAUDE_DIR/projects"
    cd "$ORIGINAL_DIR"
    exit 0
fi

# Use the shared consolidate_sessions function from lib-claude-sync.sh
consolidate_sessions "$CLAUDE_DIR/projects"

echo ""
echo "Done! Restart Claude Code to see the consolidated conversations."

cd "$ORIGINAL_DIR"
