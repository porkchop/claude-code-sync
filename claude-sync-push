#!/bin/bash
# Claude Code Conversation Sync - Push
# Syncs conversations from ~/.claude to repo and pushes to remote

set -e

ORIGINAL_DIR="$(pwd)"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Load configuration
source "$SCRIPT_DIR/lib-claude-sync.sh"
load_config "$SCRIPT_DIR"

CLAUDE_DIR="$CLAUDE_DATA_DIR"
REPO_DIR="$SCRIPT_DIR/conversations"

echo "=== Claude Code Conversation Sync - Push ==="
echo "Syncing from: $CLAUDE_DIR"
echo "Syncing to: $REPO_DIR"
echo ""

# Validate configuration
if ! validate_config; then
    cd "$ORIGINAL_DIR"
    exit 1
fi

# Check if repo is initialized
if [ ! -d "$REPO_DIR/.git" ]; then
    echo "Error: Conversations repository not initialized."
    echo ""
    echo "Run 'claude-sync-init' first to set up the repository."
    cd "$ORIGINAL_DIR"
    exit 1
fi

cd "$REPO_DIR"

# Check if encrypted repo is locked
if [ -d ".git/git-crypt" ]; then
    # Check for encrypted but not decrypted files
    if git-crypt status 2>/dev/null | grep -q "not decrypted"; then
        echo "Error: Repository is encrypted but locked."
        echo ""
        echo "Unlock first with: claude-restore-encryption-key"
        echo "Or manually: cd $REPO_DIR && git-crypt unlock ~/.claude-git-crypt.key"
        cd "$ORIGINAL_DIR"
        exit 1
    fi
fi

# Pull latest from remote first
if git remote | grep -q origin 2>/dev/null; then
    echo "Pulling latest from remote..."
    git pull origin "$CLAUDE_SYNC_BRANCH" 2>/dev/null || {
        echo "Note: Could not pull. Continuing with local merge..."
    }
    echo ""
fi

# Create directory structure
mkdir -p "$REPO_DIR/projects"
mkdir -p "$REPO_DIR/file-history"
mkdir -p "$REPO_DIR/todos"

# Sync projects (conversations) - MERGE, don't delete
echo "Merging local conversations into repo..."
rsync -av --update "$CLAUDE_DIR/projects/" "$REPO_DIR/projects/"

# Sync file-history - MERGE, don't delete
echo "Merging file history..."
rsync -av --update "$CLAUDE_DIR/file-history/" "$REPO_DIR/file-history/"

# Sync todos - MERGE, don't delete
echo "Merging todos..."
rsync -av --update "$CLAUDE_DIR/todos/" "$REPO_DIR/todos/"

# Sync global history
echo "Syncing global history..."
if [ -f "$CLAUDE_DIR/history.jsonl" ]; then
    cp "$CLAUDE_DIR/history.jsonl" "$REPO_DIR/history.jsonl"
fi

# Check if there are changes
if [ -z "$(git status --porcelain)" ]; then
    echo ""
    echo "No changes to sync."
    cd "$ORIGINAL_DIR"
    exit 0
fi

echo ""
echo "Changes detected. Committing..."
git add .

# Use configured commit message template
COMMIT_MSG="${CLAUDE_SYNC_COMMIT_MSG}"
COMMIT_MSG="${COMMIT_MSG//\{date\}/$(date '+%Y-%m-%d')}"
COMMIT_MSG="${COMMIT_MSG//\{time\}/$(date '+%H:%M:%S')}"
COMMIT_MSG="${COMMIT_MSG//\{hostname\}/$(hostname)}"

git commit -m "$COMMIT_MSG"

# Push to remote
if git remote | grep -q origin; then
    echo "Pushing to remote..."
    git push origin "$CLAUDE_SYNC_BRANCH" || {
        echo "Warning: Could not push."
        echo "  You may need to pull first or resolve conflicts."
    }
else
    echo ""
    echo "No git remote configured. Run 'claude-config' to set it up."
fi

echo ""
echo "Sync complete!"

cd "$ORIGINAL_DIR"
